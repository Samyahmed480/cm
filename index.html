<!-- generator.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆÙ„Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ - CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>body { font-family: 'Cairo', sans-serif; }</style>
    <script>
        // Dark Mode Init
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-slate-50 dark:bg-slate-950 min-h-screen p-4 md:p-8 transition-colors duration-300">
    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center border-4 border-blue-100">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h2>
            <p class="text-slate-500 mb-6 text-sm">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø­Ù…ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
            
            <div class="space-y-4">
                <input type="password" id="auth-pass" class="w-full p-3 border border-slate-300 rounded-xl text-center focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autofocus>
                <button onclick="checkAuth()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-900/20">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="mb-6 text-center relative">
            <button onclick="toggleDarkMode()" class="absolute top-0 left-0 p-2 rounded-full bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all">
                <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
            </button>
            <h1 class="text-3xl font-bold text-slate-800 dark:text-white">CRM Subscription Manager</h1>
            <p class="text-slate-500 dark:text-slate-400">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø£ÙƒÙˆØ§Ø¯</p>
        </header>

        <!-- Navigation Tabs -->
        <div class="flex flex-wrap justify-center gap-2 mb-8 bg-white dark:bg-slate-900 p-2 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 w-fit mx-auto">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn px-6 py-2 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition-all">
                <i data-lucide="layout-dashboard" class="w-4 h-4 inline-block ml-1"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­
            </button>
            <button onclick="switchTab('codes')" id="tab-codes" class="tab-btn px-6 py-2 rounded-lg text-sm font-bold transition-all bg-blue-600 text-white shadow-md">
                <i data-lucide="key" class="w-4 h-4 inline-block ml-1"></i> Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
            </button>
            <button onclick="switchTab('customers')" id="tab-customers" class="tab-btn px-6 py-2 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition-all">
                <i data-lucide="users" class="w-4 h-4 inline-block ml-1"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            </button>
            <button onclick="switchTab('services')" id="tab-services" class="tab-btn px-6 py-2 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition-all">
                <i data-lucide="package" class="w-4 h-4 inline-block ml-1"></i> Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±
            </button>
        </div>

        <!-- Content Sections -->
        
        <!-- 0. Dashboard Section -->
        <div id="view-dashboard" class="view-section hidden animate-fadeIn space-y-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center">
                        <i data-lucide="activity" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-bold">Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</p>
                        <h3 id="stat-active" class="text-2xl font-bold text-slate-800 dark:text-white">...</h3>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center gap-4">
                    <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center">
                        <i data-lucide="banknote" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ù„Ù„ÙØªØ±Ø©)</p>
                        <h3 id="stat-revenue" class="text-2xl font-bold text-slate-800 dark:text-white">...</h3>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center gap-4">
                    <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                        <h3 id="stat-customers" class="text-2xl font-bold text-slate-800 dark:text-white">...</h3>
                    </div>
                </div>
            </div>

            <!-- Profits & Filter -->
            <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-5 h-5 text-slate-600 dark:text-slate-400"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                    </h2>
                    <div class="flex gap-2 items-center">
                        <input type="date" id="filter-start" class="p-2 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-lg text-xs">
                        <span class="text-slate-400">-</span>
                        <input type="date" id="filter-end" class="p-2 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-lg text-xs">
                        <button onclick="loadDashboard()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-900 transition">ØªØµÙÙŠØ©</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right text-sm" id="profits-table">
                        <!-- Populated by JS -->
                    </table>
                </div>
            </div>
        </div>

        <!-- 1. Codes Section -->
        <div id="view-codes" class="view-section grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fadeIn">
            <!-- Generator Card -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 sticky top-6">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                        <i data-lucide="zap" class="w-5 h-5 text-blue-600"></i> Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                            <div class="relative">
                                <select id="select-customer" class="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all text-sm appearance-none">
                                    <option value="">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„...</option>
                                </select>
                                <i data-lucide="chevron-down" class="w-4 h-4 absolute left-3 top-3.5 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                            <div class="relative">
                                <select id="select-service" onchange="onServiceSelect()" class="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all text-sm appearance-none">
                                    <option value="">Ø§Ø®ØªØ± Ø®Ø¯Ù…Ø©...</option>
                                </select>
                                <i data-lucide="chevron-down" class="w-4 h-4 absolute left-3 top-3.5 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400">Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="is-lifetime" onchange="toggleDuration()" class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300">
                                    <span class="text-xs font-bold text-blue-600">Ù…Ø¯Ø© Ù…ÙØªÙˆØ­Ø© (Lifetime)</span>
                                </label>
                            </div>
                            <input type="number" id="days" class="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all font-bold text-slate-700" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… (Ù…Ø«Ø§Ù„: 365)" value="365">
                        </div>
                        
                        <button onclick="generateLocal()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition flex items-center justify-center gap-2 shadow-lg shadow-slate-900/10">
                            <i data-lucide="cpu" class="w-4 h-4"></i> ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯
                        </button>
                    </div>

                    <!-- Result Area -->
                    <div id="result-area" class="hidden mt-6 pt-6 border-t border-slate-100 dark:border-slate-700 animate-fadeIn">
                        <div class="mb-2 flex justify-between items-end">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆÙ„Ø¯</label>
                            <span id="expiry-preview" class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold"></span>
                        </div>
                        <textarea id="code-output" readonly class="w-full h-24 p-3 text-[10px] font-mono bg-slate-50 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 border border-slate-200 rounded-xl resize-none mb-3 focus:ring-2 focus:ring-blue-500 outline-none" onclick="this.select()"></textarea>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="copyCode()" class="bg-white dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 border border-slate-200 text-slate-600 py-2 rounded-lg text-xs font-bold hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center justify-center gap-1 transition-colors">
                                <i data-lucide="copy" class="w-3 h-3"></i> Ù†Ø³Ø®
                            </button>
                            <button onclick="downloadCode()" class="bg-white dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 border border-slate-200 text-slate-600 py-2 rounded-lg text-xs font-bold hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center justify-center gap-1 transition-colors">
                                <i data-lucide="download" class="w-3 h-3"></i> ØªØ­Ù…ÙŠÙ„
                            </button>
                            <button onclick="saveToFirebase()" id="btn-save-db" class="col-span-2 bg-blue-600 text-white py-2.5 rounded-lg text-xs font-bold hover:bg-blue-700 flex items-center justify-center gap-2 shadow-lg shadow-blue-900/20 transition-all active:scale-95">
                                <i data-lucide="cloud-upload" class="w-4 h-4"></i> Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- List Card -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <i data-lucide="database" class="w-5 h-5 text-purple-600"></i> Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="deleteExpiredCodes()" class="text-[10px] bg-red-50 hover:bg-red-100 text-red-600 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1 border border-red-100">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ
                            </button>
                            <button id="refresh-btn" class="text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i> ØªØ­Ø¯ÙŠØ«
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto flex-1">
                        <table class="w-full text-right text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 font-bold">
                                <tr>
                                    <th class="p-3 rounded-r-lg">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th class="p-3">Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                                    <th class="p-3">Ø§Ù„ÙƒÙˆØ¯</th>
                                    <th class="p-3 rounded-l-lg text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="firebase-list" class="divide-y divide-slate-100 dark:divide-slate-700">
                                <tr><td colspan="5" class="p-8 text-center text-slate-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Customers Section -->
        <div id="view-customers" class="view-section hidden grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fadeIn">
            <!-- Add Customer -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 sticky top-6">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                        <i data-lucide="user-plus" class="w-5 h-5 text-blue-600"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„
                    </h2>
                    <div class="space-y-3">
                        <input type="text" id="cust-name" class="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                        <div class="flex gap-2">
                            <select id="cust-country-code" class="w-24 p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" dir="ltr">
                                <option value="966">ğŸ‡¸ğŸ‡¦ +966</option>
                                <option value="20">ğŸ‡ªğŸ‡¬ +20</option>
                                <option value="971">ğŸ‡¦ğŸ‡ª +971</option>
                                <option value="965">ğŸ‡°ğŸ‡¼ +965</option>
                                <option value="974">ğŸ‡¶ğŸ‡¦ +974</option>
                                <option value="973">ğŸ‡§ğŸ‡­ +973</option>
                                <option value="968">ğŸ‡´ğŸ‡² +968</option>
                                <option value="962">ğŸ‡¯ğŸ‡´ +962</option>
                                <option value="964">ğŸ‡®ğŸ‡¶ +964</option>
                                <option value="">Other</option>
                            </select>
                            <input type="tel" id="cust-phone" class="flex-1 p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                        </div>
                        <input type="email" id="cust-email" class="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                        <textarea id="cust-notes" class="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 h-20 resize-none" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                        <button onclick="saveCustomer()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-900/20">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
                    </div>
                </div>
            </div>
            <!-- Customers List -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <i data-lucide="users" class="w-5 h-5 text-green-600"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
                        </h2>
                        <button onclick="loadCustomers()" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg transition-colors">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                        </button>
                    </div>
                    <div class="overflow-x-auto flex-1">
                        <table class="w-full text-right text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 font-bold">
                                <tr>
                                    <th class="p-3 rounded-r-lg">Ø§Ù„Ø§Ø³Ù…</th>
                                    <th class="p-3">Ø§Ù„Ù‡Ø§ØªÙ</th>
                                    <th class="p-3">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                    <th class="p-3 rounded-l-lg text-center">ØªÙˆØ§ØµÙ„</th>
                                </tr>
                            </thead>
                            <tbody id="customers-list" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Services Section -->
        <div id="view-services" class="view-section hidden grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fadeIn">
            <!-- Add Service -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 sticky top-6">
                    <h2 class="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-5 h-5 text-blue-600"></i> Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©
                    </h2>
                    <div class="space-y-3">
                        <input type="text" id="serv-name" class="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©">
                        <div class="flex gap-2">
                            <input type="number" id="serv-price" class="flex-1 p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                            <input type="text" id="serv-currency" class="w-20 p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 text-center" value="SAR" placeholder="Ø§Ù„Ø¹Ù…Ù„Ø©">
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="serv-duration" class="flex-1 p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ù…Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø© (Ø£ÙŠØ§Ù…)">
                            <label class="flex items-center gap-2 cursor-pointer whitespace-nowrap">
                                <input type="checkbox" id="serv-lifetime" class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300">
                                <span class="text-xs font-bold text-slate-500 dark:text-slate-400">Ù…ÙØªÙˆØ­ (Lifetime)</span>
                            </label>
                        </div>
                        <textarea id="serv-desc" class="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white dark:border-slate-700 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 h-20 resize-none" placeholder="ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø©..."></textarea>
                        <button onclick="saveService()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-900/20">Ø­ÙØ¸ Ø§Ù„Ø®Ø¯Ù…Ø©</button>
                    </div>
                </div>
            </div>
            <!-- Services List -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <i data-lucide="package" class="w-5 h-5 text-orange-600"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª
                        </h2>
                        <button onclick="loadServices()" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg transition-colors">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                        </button>
                    </div>
                    <div class="overflow-x-auto flex-1">
                        <table class="w-full text-right text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 font-bold">
                                <tr>
                                    <th class="p-3 rounded-r-lg">Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                                    <th class="p-3">Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th class="p-3">Ø§Ù„Ù…Ø¯Ø©</th>
                                    <th class="p-3">Ø§Ù„ÙˆØµÙ</th>
                                    <th class="p-3 rounded-l-lg text-center">Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="services-list" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Configuration ---
        // Ù‡Ø§Ù…: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù…Ù† Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyBg30vbK9ayrQn35cohJXcBiwPzuxVIgc8",
            authDomain: "crp1-51359.firebaseapp.com",
            projectId: "crp1-51359",
            storageBucket: "crp1-51359.firebasestorage.app",
            messagingSenderId: "728709328234",
            appId: "1:728709328234:web:a0f8e39a7d1210100b8913",
            measurementId: "G-J8PHEN82ZW"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, Timestamp, where, writeBatch, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase Initialized");
            loadCodes();
            // Load other data lazily or now
        } catch (e) {
            console.error("Firebase Error:", e);
            document.getElementById('firebase-list').innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ† (Config).<br><span class="text-xs text-slate-400">${e.message}</span></td></tr>`;
        }
        
        // Global state for current generated code
        let currentGeneratedData = null;
        window.allServices = {}; // Cache services for price lookup

        window.toggleDuration = function() {
            const isLifetime = document.getElementById('is-lifetime').checked;
            const daysInput = document.getElementById('days');
            if(isLifetime) {
                daysInput.disabled = true;
                daysInput.value = '';
                daysInput.placeholder = 'ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯';
                daysInput.classList.add('bg-slate-200', 'text-slate-400');
            } else {
                daysInput.disabled = false;
                daysInput.value = '365';
                daysInput.classList.remove('bg-slate-200', 'text-slate-400');
            }
        }

        window.onServiceSelect = function() {
            const id = document.getElementById('select-service').value;
            const service = window.allServices[id];
            
            if(service) {
                if (service.isLifetime) {
                    document.getElementById('is-lifetime').checked = true;
                    toggleDuration();
                } else if (service.duration) {
                    document.getElementById('is-lifetime').checked = false;
                    toggleDuration();
                    document.getElementById('days').value = service.duration;
                }
            } else {
                // Reset if no service selected
                document.getElementById('is-lifetime').checked = false; 
                toggleDuration();
                document.getElementById('days').value = '365';
            }
        }

        window.generateLocal = function() {
            const isLifetime = document.getElementById('is-lifetime').checked;
            let days = isLifetime ? 36500 : parseInt(document.getElementById('days').value); // 100 years for lifetime logic
            
            if (!isLifetime && !days) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…');

            const now = new Date();
            const expiryDate = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));
            
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… ØªØ´ÙÙŠØ±Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯
            const payload = {
                created: now.getTime(),
                expires: expiryDate.getTime(),
                secret: 'CRP_SECURE_SYSTEM_2025', // Ù…ÙØªØ§Ø­ Ø³Ø±ÙŠ Ù„Ù„ØªØ­Ù‚Ù‚
                type: isLifetime ? 'lifetime' : 'limited'
            };

            // ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const jsonStr = JSON.stringify(payload);
            const code = btoa(unescape(encodeURIComponent(jsonStr)));

            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('code-output').value = code;
            document.getElementById('expiry-preview').textContent = isLifetime ? 'ØµØ§Ù„Ø­: Ù…Ø¯Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©' : `ØµØ§Ù„Ø­ Ø­ØªÙ‰: ${expiryDate.toLocaleDateString('ar-EG')}`;
            
            // Store for saving
            currentGeneratedData = {
                code,
                days,
                expiryDate,
                isLifetime
            };
            
            // Reset save button
            const btn = document.getElementById('btn-save-db');
            if(btn) btn.disabled = false;
            btn.innerHTML = '<i data-lucide="cloud-upload" class="w-4 h-4"></i> Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            btn.classList.remove('bg-green-600', 'hover:bg-green-700');
            btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            lucide.createIcons();
        }

        window.saveToFirebase = async function() {
            if(!db) {
                alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
                return;
            }
            if(!currentGeneratedData) {
                alert('ÙŠØ±Ø¬Ù‰ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            const btn = document.getElementById('btn-save-db');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            lucide.createIcons();

            // Get Selected Data
            const custSelect = document.getElementById('select-customer');
            const servSelect = document.getElementById('select-service');
            const serviceId = servSelect.value;
            
            const customerName = custSelect.options[custSelect.selectedIndex].text;
            
            // Get price details from cached services
            const serviceData = window.allServices[serviceId] || {};
            const serviceName = serviceData.name || (servSelect.selectedIndex > 0 ? servSelect.options[servSelect.selectedIndex].text : 'Ø®Ø¯Ù…Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©');
            const price = serviceData.price ? Number(serviceData.price) : 0;
            const currency = serviceData.currency || 'SAR';
            
            const displayNote = (customerName !== 'Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„...') ? `${customerName} - ${serviceName}` : 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';

                try {
                    await addDoc(collection(db, "subscription_codes"), {
                        code: currentGeneratedData.code,
                        days: currentGeneratedData.days,
                        notes: displayNote,
                        service: serviceName,
                        price: price,
                        currency: currency,
                        created_at: Timestamp.now(),
                        expires_at: Timestamp.fromDate(currentGeneratedData.expiryDate),
                        status: 'active',
                        type: currentGeneratedData.isLifetime ? 'lifetime' : 'limited'
                    });
                    loadCodes(); // Refresh list
                    
                    btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­';
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btn.classList.add('bg-green-600', 'hover:bg-green-700');
                    lucide.createIcons();
                    
                } catch (e) {
                    console.error("Error adding document: ", e);
                    let msg = e.message;
                    if (e.code === 'permission-denied') msg = 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† (Rules) ÙÙŠ Firebase Console.';
                    alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + msg);
                    console.log("Data attempted:", currentGeneratedData);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    lucide.createIcons();
                }
        }

        window.deleteExpiredCodes = async function() {
            if(!db) return;
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) return;
            
            const btn = document.querySelector('button[onclick="deleteExpiredCodes()"]');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';
            lucide.createIcons();

            try {
                const now = Timestamp.now();
                const q = query(collection(db, "subscription_codes"), where("expires_at", "<", now));
                const snapshot = await getDocs(q);
                
                if(snapshot.empty) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
                } else {
                    const batch = writeBatch(db);
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    alert(`ØªÙ… Ø­Ø°Ù ${snapshot.size} ÙƒÙˆØ¯ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­`);
                    loadCodes();
                }
            } catch (e) {
                console.error("Error deleting expired codes: ", e);
                let msg = e.message;
                if (e.code === 'permission-denied') msg = 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† (Rules) ÙÙŠ Firebase Console.';
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + msg);
                loadCodes(); // Reload to ensure list is consistent
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
                lucide.createIcons();
            }
        }

        // --- Code Actions (Renew, Edit, Copy) ---
        window.renewCode = async function(id, currentExpiryMs) {
            const days = prompt("Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ù„Ù„ØªÙ…Ø¯ÙŠØ¯:", "30");
            if(!days || isNaN(days)) return;
            
            try {
                const currentExpiry = new Date(currentExpiryMs);
                // If expired, start from now, else add to existing
                const baseDate = currentExpiry < new Date() ? new Date() : currentExpiry;
                const newExpiry = new Date(baseDate.getTime() + (parseInt(days) * 24 * 60 * 60 * 1000));
                
                await updateDoc(doc(db, "subscription_codes", id), {
                    expires_at: Timestamp.fromDate(newExpiry)
                });
                alert("ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­");
                loadCodes();
            } catch(e) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: " + e.message);
            }
        }

        window.editCode = async function(id, currentNotes) {
            const newNotes = prompt("ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:", currentNotes);
            if(newNotes === null) return;
            
            try {
                await updateDoc(doc(db, "subscription_codes", id), {
                    notes: newNotes
                });
                loadCodes();
            } catch(e) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + e.message);
            }
        }
        
        window.copyCodeText = function(code) {
            navigator.clipboard.writeText(code).then(() => alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯"));
        }

        window.copyCode = function() {
            const copyText = document.getElementById("code-output");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value);
            alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©");
        }

        window.downloadCode = function() {
            const code = document.getElementById("code-output").value;
            if(!code) return;
            const blob = new Blob([code], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "subscription_code.txt";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function loadCodes() {
            if(!db) return;
            const listEl = document.getElementById('firebase-list');
            listEl.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</td></tr>';
            
            try {
                const q = query(collection(db, "subscription_codes"), orderBy("created_at", "desc"));
                const querySnapshot = await getDocs(q);
                
                let html = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Safe date formatting helper
                    const formatDate = (ts) => {
                        return (ts && typeof ts.toDate === 'function') ? ts.toDate().toLocaleDateString('ar-EG') : '-';
                    };
                    const created = formatDate(data.created_at);
                    const expires = formatDate(data.expires_at);
                    
                    // Calculate status
                    const isExpired = data.expires_at && data.expires_at.toDate() < new Date();
                    const statusBadge = isExpired 
                        ? '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-[10px] font-bold">Ù…Ù†ØªÙ‡ÙŠ</span>'
                        : '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[10px] font-bold">Ù†Ø´Ø·</span>';

                    html += `
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                            <td class="p-3 text-slate-500 font-mono text-xs">${created}</td>
                            <td class="p-3 text-slate-700 font-bold text-xs">${data.notes || '-'}</td>
                            <td class="p-3 text-green-600 font-bold text-xs">${expires}</td>
                            <td class="p-3 font-mono text-xs text-slate-500 truncate max-w-[200px]" title="${data.code}">${data.code.substring(0, 20)}...</td>
                            <td class="p-3 text-center flex justify-center gap-1">
                                <button onclick="copyCodeText('${data.code}')" class="p-1.5 bg-slate-100 text-slate-600 rounded hover:bg-slate-200" title="Ù†Ø³Ø®"><i data-lucide="copy" class="w-3 h-3"></i></button>
                                <button onclick="editCode('${doc.id}', '${data.notes || ''}')" class="p-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100" title="ØªØ¹Ø¯ÙŠÙ„"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                <button onclick="renewCode('${doc.id}', ${data.expires_at ? data.expires_at.toMillis() : 0})" class="p-1.5 bg-green-50 text-green-600 rounded hover:bg-green-100" title="ØªØ¬Ø¯ÙŠØ¯"><i data-lucide="calendar-plus" class="w-3 h-3"></i></button>
                                <button onclick="deleteCode('${doc.id}')" class="p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100" title="Ø­Ø°Ù"><i data-lucide="trash" class="w-3 h-3"></i></button>
                            </td>
                        </tr>
                    `;
                });
                listEl.innerHTML = html || '<tr><td colspan="5" class="p-4 text-center text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù…Ø­ÙÙˆØ¸Ø©</td></tr>';
            } catch (e) {
                console.error("Error loading docs: ", e);
                let msg = e.message;
                if (msg.includes("Cloud Firestore API")) {
                    msg = 'ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firestore Database) Ù…Ù† Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Firebase Ø£ÙˆÙ„Ø§Ù‹.<br>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Console > Build > Firestore Database > Create Database';
                } else if (e.code === 'permission-denied') {
                    msg = 'Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø±ÙÙˆØ¶ (Permission Denied).<br>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Firebase Console > Firestore Database > Rules<br>ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ù„ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø©:<br><code dir="ltr">allow read, write: if true;</code>';
                }
                listEl.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:<br>${msg}</td></tr>`;
            }
        }

        window.deleteCode = async function(id) {
            if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ØŸ')) return;
            await deleteDoc(doc(db, "subscription_codes", id));
            loadCodes();
        }

        // --- Customers Logic ---
        window.saveCustomer = async function() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            const code = document.getElementById('cust-country-code').value;
            const email = document.getElementById('cust-email').value;
            const notes = document.getElementById('cust-notes').value;

            if(!name || !phone) return alert('Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†');

            try {
                await addDoc(collection(db, "customers"), {
                    name, phone, countryCode: code, email, notes, created_at: Timestamp.now()
                });
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„');
                document.getElementById('cust-name').value = '';
                document.getElementById('cust-phone').value = '';
                loadCustomers();
            } catch(e) { alert(e.message); }
        }

        window.loadCustomers = async function() {
            if(!db) return;
            const listEl = document.getElementById('customers-list');
            const selectEl = document.getElementById('select-customer'); // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
            listEl.innerHTML = '<tr><td colspan="4" class="text-center p-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            
            try {
                const q = query(collection(db, "customers"), orderBy("created_at", "desc"));
                const snapshot = await getDocs(q);
                let html = '';
                let options = '<option value="">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„...</option>';
                
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const fullPhone = (d.countryCode || '') + d.phone;
                    const waLink = `https://wa.me/${fullPhone.replace(/\+/g,'')}`;
                    
                    html += `
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                            <td class="p-3 font-bold text-slate-700 dark:text-slate-200">${d.name}</td>
                            <td class="p-3 text-slate-600 dir-ltr text-right">${fullPhone}</td>
                            <td class="p-3 text-xs text-slate-500">${d.notes || '-'}</td>
                            <td class="p-3 text-center flex justify-center gap-2">
                                <a href="${waLink}" target="_blank" class="p-1.5 bg-green-100 text-green-600 rounded hover:bg-green-200"><i data-lucide="message-circle" class="w-4 h-4"></i></a>
                                <button onclick="deleteCustomer('${doc.id}')" class="p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100"><i data-lucide="trash" class="w-4 h-4"></i></button>
                            </td>
                        </tr>
                    `;
                    options += `<option value="${doc.id}">${d.name}</option>`;
                });
                listEl.innerHTML = html || '<tr><td colspan="4" class="text-center p-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</td></tr>';
                if(selectEl) selectEl.innerHTML = options;
                lucide.createIcons();
            } catch(e) { console.error(e); }
        }

        window.deleteCustomer = async function(id) {
            if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) {
                await deleteDoc(doc(db, "customers", id));
                loadCustomers();
            }
        }

        // --- Services Logic ---
        window.saveService = async function() {
            const name = document.getElementById('serv-name').value;
            const price = document.getElementById('serv-price').value;
            const currency = document.getElementById('serv-currency').value;
            const duration = document.getElementById('serv-duration').value;
            const isLifetime = document.getElementById('serv-lifetime').checked;
            const desc = document.getElementById('serv-desc').value;

            if(!name || !price) return alert('Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†');

            try {
                await addDoc(collection(db, "services"), {
                    name, price, currency, duration, isLifetime, desc, created_at: Timestamp.now()
                });
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø¯Ù…Ø©');
                document.getElementById('serv-name').value = '';
                document.getElementById('serv-price').value = '';
                document.getElementById('serv-duration').value = '';
                document.getElementById('serv-lifetime').checked = false;
                loadServices();
            } catch(e) { alert(e.message); }
        }

        window.loadServices = async function() {
            if(!db) return;
            const listEl = document.getElementById('services-list');
            const selectEl = document.getElementById('select-service'); // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø®Ø¯Ù…Ø§Øª
            listEl.innerHTML = '<tr><td colspan="4" class="text-center p-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            
            try {
                const q = query(collection(db, "services"), orderBy("created_at", "desc"));
                const snapshot = await getDocs(q);
                let html = '';
                let options = '<option value="">Ø§Ø®ØªØ± Ø®Ø¯Ù…Ø©...</option>';
                
                snapshot.forEach(doc => {
                    const d = doc.data();
                    window.allServices[doc.id] = d; // Cache for price lookup
                    
                    const durationText = d.isLifetime ? '<span class="text-blue-600 font-bold">Ù…Ø¯Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©</span>' : (d.duration ? d.duration + ' ÙŠÙˆÙ…' : '-');
                    html += `
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                            <td class="p-3 font-bold text-slate-700 dark:text-slate-200">${d.name}</td>
                            <td class="p-3 text-blue-600 font-bold">${d.price} <span class="text-xs text-slate-400">${d.currency}</span></td>
                            <td class="p-3 text-xs text-slate-600 dark:text-slate-400">${durationText}</td>
                            <td class="p-3 text-xs text-slate-500">${d.desc || '-'}</td>
                            <td class="p-3 text-center">
                                <button onclick="deleteService('${doc.id}')" class="p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100"><i data-lucide="trash" class="w-4 h-4"></i></button>
                            </td>
                        </tr>
                    `;
                    options += `<option value="${doc.id}">${d.name} (${d.price} ${d.currency})</option>`;
                });
                listEl.innerHTML = html || '<tr><td colspan="4" class="text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø¯Ù…Ø§Øª</td></tr>';
                if(selectEl) selectEl.innerHTML = options;
                lucide.createIcons();
            } catch(e) { console.error(e); }
        }

        window.deleteService = async function(id) {
            if(confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ')) {
                await deleteDoc(doc(db, "services", id));
                loadServices();
            }
        }

        // --- Dashboard Logic ---
        window.loadDashboard = async function() {
            if(!db) return;
            
            // UI Loading State
            document.getElementById('stat-active').innerText = '...';
            document.getElementById('stat-revenue').innerText = '...';
            document.getElementById('stat-customers').innerText = '...';
            const tableEl = document.getElementById('profits-table');
            tableEl.innerHTML = '<thead><tr class="bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 font-bold"><th class="p-3 rounded-r-lg">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-3">Ø§Ù„Ø®Ø¯Ù…Ø©</th><th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="p-3 rounded-l-lg">Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody class="divide-y divide-slate-100 dark:divide-slate-700"><tr><td colspan="4" class="p-8 text-center text-slate-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</td></tr></tbody>';

            try {
                // 1. Get Customers Count
                const custSnap = await getDocs(collection(db, "customers"));
                document.getElementById('stat-customers').innerText = custSnap.size;

                // 2. Get Subscriptions for Stats & Profits
                const subsSnap = await getDocs(query(collection(db, "subscription_codes"), orderBy("created_at", "desc")));
                
                let activeCount = 0;
                let totalRevenue = 0;
                let tableHtml = '';
                const now = new Date();

                // Filter Dates
                const startInput = document.getElementById('filter-start').value;
                const endInput = document.getElementById('filter-end').value;
                const startDate = startInput ? new Date(startInput) : null;
                const endDate = endInput ? new Date(endInput) : null;
                if(endDate) endDate.setHours(23,59,59); // End of day

                subsSnap.forEach(doc => {
                    const d = doc.data();
                    const created = d.created_at.toDate();
                    
                    // Active Count (Global, not filtered by date usually, but let's keep it global)
                    if (d.expires_at && d.expires_at.toDate() > now) {
                        activeCount++;
                    }

                    // Filter for Profits
                    if (startDate && created < startDate) return;
                    if (endDate && created > endDate) return;

                    const price = Number(d.price) || 0;
                    totalRevenue += price;

                    tableHtml += `
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                            <td class="p-3 text-slate-500 text-xs font-mono">${created.toLocaleDateString('ar-EG')}</td>
                            <td class="p-3 text-slate-700 dark:text-slate-200 font-bold text-xs">${d.service || '-'}</td>
                            <td class="p-3 text-slate-600 text-xs">${d.notes ? d.notes.split('-')[0] : '-'}</td>
                            <td class="p-3 text-green-600 font-bold text-xs">${price} ${d.currency || 'SAR'}</td>
                        </tr>
                    `;
                });

                document.getElementById('stat-active').innerText = activeCount;
                document.getElementById('stat-revenue').innerText = totalRevenue.toLocaleString() + ' SAR';
                tableEl.querySelector('tbody').innerHTML = tableHtml || '<tr><td colspan="4" class="p-8 text-center text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>';

            } catch(e) { console.error(e); }
        }

        // --- Tabs Logic ---
        window.switchTab = function(tabName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                el.classList.add('text-slate-600', 'hover:bg-slate-50', 'dark:text-slate-400', 'dark:hover:bg-slate-800');
            });
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.remove('text-slate-600', 'hover:bg-slate-50', 'dark:text-slate-400', 'dark:hover:bg-slate-800');
            activeBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md');

            if(tabName === 'customers') loadCustomers();
            if(tabName === 'services') loadServices();
            if(tabName === 'dashboard') loadDashboard();
            lucide.createIcons();
        }

        document.getElementById('refresh-btn').addEventListener('click', loadCodes);
        lucide.createIcons();

        // Auth Logic
        window.checkAuth = function() {
            const pass = document.getElementById('auth-pass').value;
         
            if(pass === 'Aziz5060#') {
                document.getElementById('auth-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('auth-overlay').remove(), 300);
            } else {
                alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                document.getElementById('auth-pass').value = '';
            }
        }
        document.getElementById('auth-pass').addEventListener('keypress', (e) => e.key === 'Enter' && checkAuth());

        // Dark Mode Toggle
        window.toggleDarkMode = function() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }
    </script>
</body>
</html>
