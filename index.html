<!-- generator.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مولد أكواد الاشتراك - CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>body { font-family: 'Cairo', sans-serif; }</style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">
    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center border-4 border-blue-100">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">نظام إدارة الاشتراكات</h2>
            <p class="text-slate-500 mb-6 text-sm">هذه الصفحة محمية. يرجى إدخال كلمة المرور للمتابعة.</p>
            
            <div class="space-y-4">
                <input type="password" id="auth-pass" class="w-full p-3 border border-slate-300 rounded-xl text-center focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="كلمة المرور" autofocus>
                <button onclick="checkAuth()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-900/20">تسجيل الدخول</button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800">CRM Subscription Manager</h1>
            <p class="text-slate-500">لوحة التحكم في الاشتراكات والأكواد</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Generator Card -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 sticky top-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="zap" class="w-5 h-5 text-blue-600"></i> إنشاء كود جديد
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">مدة الاشتراك (أيام)</label>
                            <input type="number" id="days" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all font-bold text-slate-700" placeholder="365" value="365">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">ملاحظات / اسم العميل</label>
                            <input type="text" id="notes" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all text-sm" placeholder="اسم العميل...">
                        </div>
                        
                        <button onclick="generateLocal()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition flex items-center justify-center gap-2 shadow-lg shadow-slate-900/10">
                            <i data-lucide="cpu" class="w-4 h-4"></i> توليد الكود
                        </button>
                    </div>

                    <!-- Result Area -->
                    <div id="result-area" class="hidden mt-6 pt-6 border-t border-slate-100 animate-fadeIn">
                        <div class="mb-2 flex justify-between items-end">
                            <label class="text-xs font-bold text-slate-500">الكود المولد</label>
                            <span id="expiry-preview" class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold"></span>
                        </div>
                        <textarea id="code-output" readonly class="w-full h-24 p-3 text-[10px] font-mono bg-slate-50 border border-slate-200 rounded-xl resize-none mb-3 focus:ring-2 focus:ring-blue-500 outline-none" onclick="this.select()"></textarea>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="copyCode()" class="bg-white border border-slate-200 text-slate-600 py-2 rounded-lg text-xs font-bold hover:bg-slate-50 flex items-center justify-center gap-1 transition-colors">
                                <i data-lucide="copy" class="w-3 h-3"></i> نسخ
                            </button>
                            <button onclick="downloadCode()" class="bg-white border border-slate-200 text-slate-600 py-2 rounded-lg text-xs font-bold hover:bg-slate-50 flex items-center justify-center gap-1 transition-colors">
                                <i data-lucide="download" class="w-3 h-3"></i> تحميل
                            </button>
                            <button onclick="saveToFirebase()" id="btn-save-db" class="col-span-2 bg-blue-600 text-white py-2.5 rounded-lg text-xs font-bold hover:bg-blue-700 flex items-center justify-center gap-2 shadow-lg shadow-blue-900/20 transition-all active:scale-95">
                                <i data-lucide="cloud-upload" class="w-4 h-4"></i> حفظ في قاعدة البيانات
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- List Card -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="database" class="w-5 h-5 text-purple-600"></i> الأكواد المحفوظة
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="deleteExpiredCodes()" class="text-xs bg-red-50 hover:bg-red-100 text-red-600 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1 border border-red-100">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> حذف المنتهي
                            </button>
                            <button id="refresh-btn" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i> تحديث
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto flex-1">
                        <table class="w-full text-right text-sm">
                            <thead class="bg-slate-50 text-slate-500 font-bold">
                                <tr>
                                    <th class="p-3 rounded-r-lg">التاريخ</th>
                                    <th class="p-3">العميل</th>
                                    <th class="p-3">الانتهاء</th>
                                    <th class="p-3">الكود</th>
                                    <th class="p-3 rounded-l-lg text-center">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="firebase-list" class="divide-y divide-slate-100">
                                <tr><td colspan="5" class="p-8 text-center text-slate-400">جاري التحميل...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Configuration ---
        // هام: استبدل البيانات التالية ببيانات مشروعك من Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyBg30vbK9ayrQn35cohJXcBiwPzuxVIgc8",
            authDomain: "crp1-51359.firebaseapp.com",
            projectId: "crp1-51359",
            storageBucket: "crp1-51359.firebasestorage.app",
            messagingSenderId: "728709328234",
            appId: "1:728709328234:web:a0f8e39a7d1210100b8913",
            measurementId: "G-J8PHEN82ZW"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, Timestamp, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase Initialized");
            loadCodes();
        } catch (e) {
            console.error("Firebase Error:", e);
            document.getElementById('firebase-list').innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">خطأ في الاتصال بـ Firebase. تأكد من إعدادات التكوين (Config).<br><span class="text-xs text-slate-400">${e.message}</span></td></tr>`;
        }
        
        // Global state for current generated code
        let currentGeneratedData = null;

        window.generateLocal = function() {
            const days = parseInt(document.getElementById('days').value);
            if (!days) return alert('يرجى إدخال عدد الأيام');

            const now = new Date();
            const expiryDate = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));
            
            // البيانات التي سيتم تشفيرها داخل الكود
            const payload = {
                created: now.getTime(),
                expires: expiryDate.getTime(),
                secret: 'CRP_SECURE_SYSTEM_2025', // مفتاح سري للتحقق
                type: 'full_access'
            };

            // تشفير البيانات
            const jsonStr = JSON.stringify(payload);
            const code = btoa(unescape(encodeURIComponent(jsonStr)));

            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('code-output').value = code;
            document.getElementById('expiry-preview').textContent = `صالح حتى: ${expiryDate.toLocaleDateString('ar-EG')}`;
            
            // Store for saving
            currentGeneratedData = {
                code,
                days,
                expiryDate
            };
            
            // Reset save button
            const btn = document.getElementById('btn-save-db');
            if(btn) btn.disabled = false;
            btn.innerHTML = '<i data-lucide="cloud-upload" class="w-4 h-4"></i> حفظ في قاعدة البيانات';
            btn.classList.remove('bg-green-600', 'hover:bg-green-700');
            btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            lucide.createIcons();
        }

        window.saveToFirebase = async function() {
            if(!db) {
                alert('خطأ: لم يتم الاتصال بقاعدة البيانات. يرجى التحقق من الإعدادات والاتصال بالإنترنت.');
                return;
            }
            if(!currentGeneratedData) {
                alert('يرجى توليد كود أولاً');
                return;
            }
            
            const btn = document.getElementById('btn-save-db');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> جاري الحفظ...';
            lucide.createIcons();

            const notes = document.getElementById('notes').value || '';

                try {
                    await addDoc(collection(db, "subscription_codes"), {
                        code: currentGeneratedData.code,
                        days: currentGeneratedData.days,
                        notes: notes,
                        created_at: Timestamp.now(),
                        expires_at: Timestamp.fromDate(currentGeneratedData.expiryDate),
                        status: 'active'
                    });
                    loadCodes(); // Refresh list
                    
                    btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> تم الحفظ بنجاح';
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btn.classList.add('bg-green-600', 'hover:bg-green-700');
                    lucide.createIcons();
                    
                } catch (e) {
                    console.error("Error adding document: ", e);
                    let msg = e.message;
                    if (e.code === 'permission-denied') msg = 'تم رفض الإذن. يرجى التحقق من قواعد الأمان (Rules) في Firebase Console.';
                    alert("فشل الحفظ في قاعدة البيانات: " + msg);
                    console.log("Data attempted:", currentGeneratedData);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    lucide.createIcons();
                }
        }

        window.deleteExpiredCodes = async function() {
            if(!db) return;
            if(!confirm('هل أنت متأكد من حذف جميع الأكواد المنتهية الصلاحية؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            
            const btn = document.querySelector('button[onclick="deleteExpiredCodes()"]');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> جاري الحذف...';
            lucide.createIcons();

            try {
                const now = Timestamp.now();
                const q = query(collection(db, "subscription_codes"), where("expires_at", "<", now));
                const snapshot = await getDocs(q);
                
                if(snapshot.empty) {
                    alert('لا توجد أكواد منتهية الصلاحية');
                } else {
                    const batch = writeBatch(db);
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    alert(`تم حذف ${snapshot.size} كود منتهي الصلاحية بنجاح`);
                    loadCodes();
                }
            } catch (e) {
                console.error("Error deleting expired codes: ", e);
                let msg = e.message;
                if (e.code === 'permission-denied') msg = 'تم رفض الإذن. يرجى التحقق من قواعد الأمان (Rules) في Firebase Console.';
                alert("حدث خطأ أثناء الحذف: " + msg);
                loadCodes(); // Reload to ensure list is consistent
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
                lucide.createIcons();
            }
        }

        window.copyCode = function() {
            const copyText = document.getElementById("code-output");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value);
            alert("تم نسخ الكود إلى الحافظة");
        }

        window.downloadCode = function() {
            const code = document.getElementById("code-output").value;
            if(!code) return;
            const blob = new Blob([code], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "subscription_code.txt";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function loadCodes() {
            if(!db) return;
            const listEl = document.getElementById('firebase-list');
            listEl.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-400">جاري التحديث...</td></tr>';
            
            try {
                const q = query(collection(db, "subscription_codes"), orderBy("created_at", "desc"));
                const querySnapshot = await getDocs(q);
                
                let html = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Safe date formatting helper
                    const formatDate = (ts) => {
                        return (ts && typeof ts.toDate === 'function') ? ts.toDate().toLocaleDateString('ar-EG') : '-';
                    };
                    const created = formatDate(data.created_at);
                    const expires = formatDate(data.expires_at);
                    
                    html += `
                        <tr class="hover:bg-slate-50">
                            <td class="p-3 text-slate-500 font-mono text-xs">${created}</td>
                            <td class="p-3 text-slate-700 font-bold text-xs">${data.notes || '-'}</td>
                            <td class="p-3 text-green-600 font-bold text-xs">${expires}</td>
                            <td class="p-3 font-mono text-xs text-slate-500 truncate max-w-[200px]" title="${data.code}">${data.code.substring(0, 20)}...</td>
                            <td class="p-3 text-center"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[10px] font-bold">نشط</span></td>
                        </tr>
                    `;
                });
                listEl.innerHTML = html || '<tr><td colspan="5" class="p-4 text-center text-slate-400">لا توجد أكواد محفوظة</td></tr>';
            } catch (e) {
                console.error("Error loading docs: ", e);
                let msg = e.message;
                if (msg.includes("Cloud Firestore API")) {
                    msg = 'يجب تفعيل قاعدة البيانات (Firestore Database) من لوحة تحكم Firebase أولاً.<br>اذهب إلى Console > Build > Firestore Database > Create Database';
                } else if (e.code === 'permission-denied') {
                    msg = 'إذن الوصول مرفوض (Permission Denied).<br>يرجى الذهاب إلى Firebase Console > Firestore Database > Rules<br>وتغيير القواعد لتسمح بالقراءة والكتابة:<br><code dir="ltr">allow read, write: if true;</code>';
                }
                listEl.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">خطأ في الاتصال:<br>${msg}</td></tr>`;
            }
        }

        document.getElementById('refresh-btn').addEventListener('click', loadCodes);
        lucide.createIcons();

        // Auth Logic
        window.checkAuth = function() {
            const pass = document.getElementById('auth-pass').value;
         
            if(pass === 'Aziz5060#') {
                document.getElementById('auth-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('auth-overlay').remove(), 300);
            } else {
                alert('كلمة المرور غير صحيحة');
                document.getElementById('auth-pass').value = '';
            }
        }
        document.getElementById('auth-pass').addEventListener('keypress', (e) => e.key === 'Enter' && checkAuth());
    </script>
</body>
</html>
